<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MemeMorphs — Wallet Login & Profile</title>
  <style>
    body {
      background: radial-gradient(circle at top, #101830 0, #050816 45%, #02030a 100%);
      color: #e0f5ff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 40px 12px 80px;
    }
    h1 {
      margin-bottom: 16px;
      color: #4fd1ff;
      text-shadow: 0 0 18px #00f0ff;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 26px;
      text-align: center;
    }
    .subtitle {
      font-size: 14px;
      color: #9ae6ff;
      margin-bottom: 28px;
      text-align: center;
      opacity: 0.8;
    }
    button {
      background: linear-gradient(90deg, #00e5ff, #7b61ff);
      border: none;
      padding: 12px 26px;
      border-radius: 999px;
      color: #050816;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 20px;
      box-shadow: 0 0 18px rgba(0, 240, 255, 0.45);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, opacity 0.12s ease-out;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 0 26px rgba(0, 240, 255, 0.8);
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    #status, #result, #profileCard {
      width: 100%;
      max-width: 720px;
      background: rgba(4, 7, 24, 0.96);
      border-radius: 18px;
      padding: 14px 18px;
      margin-top: 10px;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid rgba(41, 59, 122, 0.9);
      box-shadow: 0 0 20px rgba(0, 0, 40, 0.9);
    }
    #status {
      color: #9ae6ff;
    }
    #result {
      color: #e9f5ff;
      max-height: 220px;
      overflow: auto;
    }
    #profileCard {
      margin-top: 22px;
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 16px;
      color: #4fe3ff;
      text-shadow: 0 0 10px #00f0ff;
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .field {
      flex: 1 1 220px;
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .field label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #7aa5ff;
      margin-bottom: 4px;
    }
    .field input,
    .field textarea {
      background: rgba(10, 16, 40, 0.96);
      border-radius: 10px;
      border: 1px solid #283a6a;
      color: #e9f5ff;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
    }
    .field input:focus,
    .field textarea:focus {
      border-color: #4fd1ff;
      box-shadow: 0 0 0 1px rgba(79, 209, 255, 0.5);
    }
    .field textarea {
      min-height: 70px;
      resize: vertical;
    }
    .profile-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .profile-footer small {
      font-size: 11px;
      color: #a0aec0;
      opacity: 0.85;
    }
    .save-btn {
      background: linear-gradient(90deg, #00ffb3, #4fd1ff);
      padding: 9px 18px;
      border-radius: 999px;
      font-size: 13px;
    }
    .hidden {
      display: none;
    }
    .address-chip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(10, 24, 55, 0.9);
      border: 1px solid #32466e;
      display: inline-block;
      margin-bottom: 6px;
      color: #cbd5f5;
    }
  </style>
</head>
<body>
  <h1>MemeMorphs — Wallet Login</h1>
  <div class="subtitle">
    Connect your Base wallet, then edit your MemeMorph Explorer profile.
  </div>

  <button id="loginBtn">Connect Wallet & Login</button>

  <div id="status">Status: idle</div>
  <div id="result">Result will appear here…</div>

  <div id="profileCard" class="hidden">
    <div class="card-title">Profile</div>
    <div id="addressChip" class="address-chip"></div>

    <div class="field-row">
      <div class="field">
        <label for="displayName">Display Name</label>
        <input id="displayName" placeholder="MemeMorph Ranger" />
      </div>
      <div class="field">
        <label for="handle">Handle</label>
        <input id="handle" placeholder="@mememorph" />
      </div>
    </div>

    <div class="field">
      <label for="bio">Bio</label>
      <textarea id="bio" placeholder="Short bio about you or your MemeMorph quests…"></textarea>
    </div>

    <div class="field-row">
      <div class="field">
        <label for="website">Website</label>
        <input id="website" placeholder="https://…" />
      </div>
      <div class="field">
        <label for="twitter">Twitter / X</label>
        <input id="twitter" placeholder="https://x.com/…" />
      </div>
      <div class="field">
        <label for="discord">Discord</label>
        <input id="discord" placeholder="yourname#1234 or invite link" />
      </div>
    </div>

    <div class="profile-footer">
      <small>
        These settings are stored in Supabase and linked to your wallet address.
      </small>
      <button id="saveProfileBtn" class="save-btn">Save Profile</button>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const FN_BASE = "https://jfrtjbnnqvchrklgrres.supabase.co/functions/v1";

    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const btn = document.getElementById("loginBtn");
    const profileCard = document.getElementById("profileCard");
    const addressChip = document.getElementById("addressChip");
    const saveBtn = document.getElementById("saveProfileBtn");

    const displayNameEl = document.getElementById("displayName");
    const handleEl = document.getElementById("handle");
    const bioEl = document.getElementById("bio");
    const websiteEl = document.getElementById("website");
    const twitterEl = document.getElementById("twitter");
    const discordEl = document.getElementById("discord");

    function setStatus(msg) {
      statusEl.textContent = "Status: " + msg;
    }
    function setResult(obj) {
      resultEl.textContent = typeof obj === "string"
        ? obj
        : JSON.stringify(obj, null, 2);
    }

    function getStored() {
      return {
        token: localStorage.getItem("mm_token") || null,
        address: localStorage.getItem("mm_address") || null,
      };
    }

    function showProfileUI(address) {
      addressChip.textContent = "Address: " + address;
      profileCard.classList.remove("hidden");
    }

    async function loadProfile(address) {
      try {
        setStatus("loading profile…");
        const res = await fetch(
          FN_BASE + "/profile?address=" + encodeURIComponent(address)
        );
        const json = await res.json();
        if (!res.ok) {
          setStatus("profile load error");
          setResult(json);
          return;
        }
        const p = json.profile;
        if (p) {
          displayNameEl.value = p.display_name || "";
          handleEl.value = p.handle || "";
          bioEl.value = p.bio || "";
          websiteEl.value = p.website || "";
          twitterEl.value = p.twitter || "";
          discordEl.value = p.discord || "";
          setStatus("profile loaded");
        } else {
          setStatus("no profile yet — create one");
        }
      } catch (err) {
        setStatus("profile load error");
        setResult(String(err));
      }
    }

    async function saveProfile() {
      const { token, address } = getStored();
      if (!token || !address) {
        alert("Wallet not logged in yet.");
        return;
      }
      try {
        setStatus("saving profile…");
        const body = {
          display_name: displayNameEl.value.trim(),
          handle: handleEl.value.trim(),
          bio: bioEl.value.trim(),
          website: websiteEl.value.trim(),
          twitter: twitterEl.value.trim(),
          discord: discordEl.value.trim(),
        };
        const res = await fetch(FN_BASE + "/profile", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
          },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        if (!res.ok) {
          setStatus("profile save error");
          setResult(json);
          return;
        }
        setStatus("profile saved");
        setResult(json);
      } catch (err) {
        setStatus("profile save error");
        setResult(String(err));
      }
    }

    async function login() {
      try {
        if (!window.ethereum) {
          alert("MetaMask (или друг wallet) не е открит в браузъра.");
          return;
        }
        btn.disabled = true;
        setStatus("connecting wallet…");

        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts"
        });
        const account = accounts[0];
        setStatus("wallet connected: " + account);

        setStatus("fetching nonce…");
        const nonceRes = await fetch(FN_BASE + "/siwe/nonce");
        const nonceJson = await nonceRes.json();
        if (!nonceRes.ok) {
          setStatus("nonce error");
          setResult(nonceJson);
          btn.disabled = false;
          return;
        }
        const { key, nonce } = nonceJson;

        const message = `MemeMorphs Login
Address: ${account}
Nonce: ${nonce}`;

        setStatus("signing message in wallet…");
        const signature = await window.ethereum.request({
          method: "personal_sign",
          params: [message, account]
        });

        setStatus("verifying on backend…");
        const verifyRes = await fetch(FN_BASE + "/siwe/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ key, message, signature })
        });

        const verifyJson = await verifyRes.json();
        if (!verifyRes.ok) {
          setStatus("verify error");
          setResult(verifyJson);
          btn.disabled = false;
          return;
        }

        setStatus("login success");
        setResult(verifyJson);

        if (verifyJson.token && verifyJson.address) {
          localStorage.setItem("mm_token", verifyJson.token);
          localStorage.setItem("mm_address", verifyJson.address);
          showProfileUI(verifyJson.address);
          loadProfile(verifyJson.address);
        }

      } catch (err) {
        console.error(err);
        setStatus("error");
        setResult(String(err));
      } finally {
        btn.disabled = false;
      }
    }

    // Авто-логин ако вече има токен
    window.addEventListener("DOMContentLoaded", () => {
      const { token, address } = getStored();
      if (token && address) {
        setStatus("session restored");
        showProfileUI(address);
        loadProfile(address);
      }
    });

    btn.addEventListener("click", login);
    saveBtn.addEventListener("click", saveProfile);
  </script>
</body>
</html>
